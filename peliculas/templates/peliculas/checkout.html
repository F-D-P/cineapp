<!-- peliculas/templates/peliculas/checkout.html -->
{% extends "peliculas/base.html" %} 
{% load static %} 
{% block content %}
<div class="container mt-5 text-center">
  <h3>Pago de tu reserva #{{ reserva.id }}</h3>
  <p>
    {{ reserva.funcion.pelicula.titulo }} · 
    {{ reserva.funcion.fecha|date:"d/m/Y" }} {{ reserva.funcion.hora|time:"H:i" }}
  </p>
  <p>Total: ${{ reserva.funcion.precio }} x {{ reserva.cantidad }}</p>

  <!-- Métodos de pago más usados en Argentina -->
  <div class="mb-4">
    <div class="d-flex flex-wrap justify-content-center gap-4">
      <button class="btn btn-light border metodo-btn btn-lg p-3" data-metodo="visa">
        <img src="{% static 'img/cards/visa.png' %}" alt="Visa" height="48" />
      </button>
      <button class="btn btn-light border metodo-btn btn-lg p-3" data-metodo="mastercard">
        <img src="{% static 'img/cards/mastercard.png' %}" alt="Mastercard" height="48" />
      </button>
      <button class="btn btn-light border metodo-btn btn-lg p-3" data-metodo="amex">
        <img src="{% static 'img/cards/americanExpress.png' %}" alt="American Express" height="48" />
      </button>
      <button class="btn btn-light border metodo-btn btn-lg p-3" data-metodo="naranjax">
        <img src="{% static 'img/cards/naranjaX.png' %}" alt="Naranja X" height="48" />
      </button>
      <button class="btn btn-light border metodo-btn btn-lg p-3" data-metodo="cabal">
        <img src="{% static 'img/cards/cabal.png' %}" alt="Cabal" height="48" />
      </button>
      <button class="btn btn-light border metodo-btn btn-lg p-3" data-metodo="mercadopago">
        <img src="{% static 'img/cards/mercadopago.png' %}" alt="Mercado Pago" height="48" />
      </button>
      <button class="btn btn-light border metodo-btn btn-lg p-3" data-metodo="rapipago">
        <img src="{% static 'img/cards/rapipago.png' %}" alt="Rapipago" height="48" />
      </button>
      <button class="btn btn-light border metodo-btn btn-lg p-3" data-metodo="pagofacil">
        <img src="{% static 'img/cards/pagofacil.png' %}" alt="Pago Fácil" height="48" />
      </button>
    </div>
  </div>

  <!-- Formulario de tarjeta -->
  <div id="formulario-tarjeta" class="mt-4" style="display: none">
    <h5 class="mb-3">Pago con tarjeta</h5>
    <form id="form-pago-tarjeta" method="post">
      {% csrf_token %}
      <div class="mb-3">
        <label for="nombre" class="form-label">Nombre del titular</label>
        <input type="text" class="form-control" id="nombre" required />
      </div>
      <div class="mb-3">
        <label for="numero" class="form-label">Número de tarjeta</label>
        <input type="text" class="form-control" id="numero" maxlength="19" required />
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="vencimiento" class="form-label">Vencimiento (MM/AA)</label>
          <input type="text" class="form-control" id="vencimiento" placeholder="MM/AA" required />
        </div>
        <div class="col-md-6 mb-3">
          <label for="cvv" class="form-label">CVV</label>
          <input type="text" class="form-control" id="cvv" maxlength="4" required />
        </div>
      </div>
      <div class="mb-3">
        <label for="dni" class="form-label">DNI</label>
        <input type="text" class="form-control" id="dni" required />
      </div>
      <div class="mb-3">
        <label for="email" class="form-label">Correo electrónico</label>
        <input type="email" class="form-control" id="email" required />
      </div>
      <div class="mb-3">
        <label for="cuotas" class="form-label">Cuotas</label>
        <select class="form-select" id="cuotas">
          <option value="1">1 cuota</option>
          <option value="3">3 cuotas</option>
          <option value="6">6 cuotas</option>
          <option value="12">12 cuotas</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary">Pagar ahora</button>
    </form>
  </div>

  <!-- Contenedor QR MercadoPago -->
  <div id="formulario-qr" class="mt-4" style="display: none">
    <h5 class="mb-3">Pago con MercadoPago QR</h5>
    <p>Escaneá este código QR con tu app de MercadoPago:</p>
    <div id="cardPaymentBrick_container" class="mb-4"></div>
  </div>

  <!-- Ticket Rapipago/Pago Fácil -->
  <div id="formulario-ticket" class="mt-4" style="display: none">
    <h5 class="mb-3">Pago en sucursal</h5>
    <p>Presentá este comprobante en Rapipago o Pago Fácil:</p>
    <div class="alert alert-info">
      Reserva #{{ reserva.id }} · {{ reserva.funcion.pelicula.titulo }}<br>
      Fecha: {{ reserva.funcion.fecha|date:"d/m/Y" }} {{ reserva.funcion.hora|time:"H:i" }}<br>
      Total: ${{ reserva.funcion.precio }} x {{ reserva.cantidad }}
    </div>
  </div>

  <div id="paymentFeedback" class="alert" style="display: none"></div>

  <a href="{% url 'mis_entradas' %}" class="btn btn-outline-secondary mt-3">Ver mis reservas</a>
</div>

<script src="https://sdk.mercadopago.com/js/v2"></script>
<script>
  document.querySelectorAll(".metodo-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const metodo = btn.dataset.metodo;
      document.getElementById("formulario-tarjeta").style.display = "none";
      document.getElementById("formulario-qr").style.display = "none";
      document.getElementById("formulario-ticket").style.display = "none";

      if (["visa","mastercard","amex","naranjax","cabal"].includes(metodo)) {
        document.getElementById("formulario-tarjeta").style.display = "block";
      } else if (metodo === "mercadopago") {
        document.getElementById("formulario-qr").style.display = "block";
      } else if (["rapipago","pagofacil"].includes(metodo)) {
        document.getElementById("formulario-ticket").style.display = "block";
      }
    });
  });

  // Simular pago exitoso al enviar el formulario de tarjeta
  document.getElementById("form-pago-tarjeta").addEventListener("submit", function (e) {
    e.preventDefault();
    alert("✅ Pago exitoso con tarjeta. ¡Gracias por tu compra!");
    window.location.href = "{% url 'pago_exitoso' reserva.id %}";
  });
</script>
{% endblock %}
